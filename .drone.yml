workspace:
  base: /kowala/workspace
  path: src/github.com/kowala-tech/kcoin

clone:
  git:
    image: plugins/git
    tags: true

pipeline:
  test:
    image: kowalatech/go:1.0.3
    commands:
      - make test
      - make lint
    when:
      event: [pull_request]

  # Builds the docker image to be used in the `e2e` step right into the docker service.
  docker-image-for-e2e:
    image: docker
    environment:
    - DOCKER_HOST=tcp://docker:2375
    commands: 
    - docker build -t kowalatech/kusd:dev -f client/kcoin.Dockerfile .
    - docker build -t kowalatech/bootnode:dev -f client/bootnode.Dockerfile .
    when:
      event: [pull_request]

  e2e:
    image: kowalatech/go:1.0.3
    environment:
    - DOCKER_HOST=tcp://docker:2375
    - DOCKER_PUBLIC_IP=docker
    commands:
      - make e2e
    when:
      event: [pull_request]

  docker_kusd_dev:
    group: docker-deployment
    image: plugins/docker
    repo: kowalatech/kusd
    secrets: [ docker_username, docker_password ]
    tags: dev
    dockerfile: client/kcoin.Dockerfile
    when:
      branch: [dev]
      event: [push, tag]

  docker_bootnode_dev:
    group: docker-deployment
    image: plugins/docker
    repo: kowalatech/bootnode
    secrets: [ docker_username, docker_password ]
    tags: dev
    dockerfile: client/bootnode.Dockerfile
    when:
      branch: [dev]
      event: [push, tag]

  docker_faucet_dev:
    group: docker-deployment
    image: plugins/docker
    repo: kowalatech/faucet
    secrets: [ docker_username, docker_password ]
    tags: dev
    dockerfile: client/faucet.Dockerfile
    when:
      branch: [dev]
      event: [push, tag]

  docker_kusd_tag:
    group: docker-deployment
    image: kowalatech/drone-docker
    repo: kowalatech/kusd
    secrets: [ docker_username, docker_password ]
    privileged: true
    auto_tag: true
    dockerfile: client/kcoin.Dockerfile
    when:
      event: tag

  docker_bootnode_tag:
    group: docker-deployment
    image: kowalatech/drone-docker
    repo: kowalatech/bootnode
    secrets: [ docker_username, docker_password ]
    privileged: true
    auto_tag: true
    dockerfile: client/bootnode.Dockerfile
    when:
      event: tag

  docker_faucet_tag:
    group: docker-deployment
    image: kowalatech/drone-docker
    repo: kowalatech/faucet
    secrets: [ docker_username, docker_password ]
    privileged: true
    auto_tag: true
    dockerfile: client/faucet.Dockerfile
    when:
      event: tag

  build-artifacts:
    image: kowalatech/go:1.0.3
    environment:
      - DOCKER_HOST=tcp://docker:2375
    commands:
      - make kcoin-cross
    when:
      event: [push, tag]
      branch: [dev]

  s3:
    image: plugins/s3
    bucket: releases.kowala.io
    region: us-east-1
    acl: public-read
    source: client/build/bin/kcoin-*.zip
    strip_prefix: client/build/bin/
    target: /
    secrets: [aws_access_key_id, aws_secret_access_key]
    when:
      event: [push, tag]
      branch: [dev]

  notify-dev:
    group: notify
    image: plugins/slack
    secrets: [ slack_webhook ] 
    channel: ci-notifications
    username: drone
    template: >
        *CI build #{{build.number}}* ({{build.event}} to `{{build.branch}}`{{#if build.pull}}[PR #{{build.pull}}]{{/if}} by @{{build.author}}) *{{#success build.status}}successful{{else}}failed{{/success}}* after {{since build.started}}

        _${DRONE_COMMIT_MESSAGE}_
        
        {{#if build.tag}}`v{{build.tag}}` | {{/if}}Commit <${DRONE_COMMIT_LINK}|{{build.commit}}> | <{{build.link}}|Build #{{build.number}}>
    when:
      status: failure 
      event: [push, tag, pull_request]

services:
  docker:
    image: docker:dind
    command: [ '-l', 'fatal' ]
    privileged: true
